<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>ASP Builder + PDF to JSON</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#f5f5f5;color:#222}
body{margin:0;padding:1rem;max-width:1100px;margin-inline:auto}
button,input,textarea{font:inherit;padding:.45rem .5rem;border:1px solid #ccc;border-radius:.4rem}
button{cursor:pointer}
pre{background:#fff;border:1px solid #ddd;padding:.5rem;border-radius:.5rem;overflow:auto;max-height:60vh}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.min.js"></script>
</head>
<body>

<h1>ASP Builder</h1>
<p><button id="genBtn">üìÑ Generate pricebook.json from PDF</button></p>
<div id="genStatus" style="font-size:.8rem;color:#555;margin:.3rem 0;"></div>
<pre id="jsonOutput" style="display:none;"></pre>

<script>
const PDF_URL = "https://martinbibb-cmd.github.io/Asp/Manual_Pricebook_28.05.2025%20-%20Updated.pdf"; // update if needed
const lineRe = /^(p?\d{3,5})\s+(.*?)\s+¬£?(\d+(?:\.\d{1,2})?)$/i;

function withCacheBuster(url){
  const separator = url.includes("?") ? "&" : "?";
  return `${url}${separator}_=${Date.now()}`;
}

async function fetchPdfText(url){
  const loadingTask = window.pdfjsLib.getDocument(withCacheBuster(url));
  const pdf = await loadingTask.promise;
  let text = "";
  for(let i=1;i<=pdf.numPages;i++){
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    text += content.items.map(it=>it.str).join(" ") + "\n";
  }
  return text;
}

function extractRows(txt){
  const rows=[];
  txt.split(/\r?\n/).forEach(line=>{
    line=line.trim();
    const m=lineRe.exec(line);
    if(m){
      rows.push({code:m[1],description:m[2].trim(),price:parseFloat(m[3])});
    }
  });
  return rows;
}

async function generate(){
  const status=document.getElementById("genStatus");
  const out=document.getElementById("jsonOutput");
  status.textContent="Loading PDF...";
  out.style.display="none";
  try{
    const text=await fetchPdfText(PDF_URL);
    status.textContent="Parsing text...";
    const rows=extractRows(text);
    const json=JSON.stringify(rows,null,2);
    out.textContent=json;
    out.style.display="block";
    status.textContent=`‚úÖ Found ${rows.length} items. Copy or download below.`;
    const blob=new Blob([json],{type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download="pricebook.json";
    a.textContent="Download pricebook.json";
    status.append(" ",a);
  }catch(e){
    status.textContent="‚ùå "+e.message;
    console.error(e);
  }
}

document.getElementById("genBtn").onclick=generate;
</script>
</body>
</html>
